<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tracker Campaña 3→4 — Pólizas 24m</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    html,body{background:#f8fafc}
    .badge{font-size:.70rem; padding:.15rem .5rem; border-radius:999px}
    .card{cursor:pointer}
    .card:hover{box-shadow:0 6px 24px rgba(0,0,0,.06)}
    th.sortable{cursor:pointer; user-select:none}
    th.sortable .arrow{font-size:.7em; opacity:.6; margin-left:.25rem}
    .switch{border:1px solid rgba(0,0,0,.08); border-radius:999px; background:#fff;}
    .switch button{padding:.25rem .6rem; border-radius:999px; font-size:.75rem}
    .switch button.active{background:#111827; color:#fff}
    .seg-container details{border:1px solid rgba(0,0,0,.06); border-radius:12px; background:#fff}
    .seg-container details+details{margin-top:.5rem}
    .seg-container summary{list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:.5rem .75rem; border-bottom:1px solid rgba(0,0,0,.06); background:#f9fafb; border-radius:12px}
    .seg-container summary::-webkit-details-marker{display:none}
    .seg-dealer{font-weight:600}
    .seg-count{font-size:.7rem; padding:.15rem .5rem; border-radius:999px; background:#eef2ff; color:#3730a3}
    .seg-ul{padding:.35rem .5rem}
    .seg-li{display:flex; align-items:center; justify-content:space-between; padding:.25rem .25rem}
    .seg-pill{font-size:.7rem; border:1px solid rgba(0,0,0,.08); border-radius:999px; padding:.1rem .5rem}
    .seg-actions button{border:1px solid rgba(0,0,0,.08); border-radius:999px; padding:.2rem .5rem; font-size:.7rem}
    .seg-details{overflow:hidden}
    .seg-details[open] summary{background:#eef2ff}
    .seg-vendor{display:flex; align-items:center; gap:.5rem}
    .seg-dot{width:.45rem; height:.45rem; border-radius:999px; display:inline-block}
    .seg-ul li:hover{background:#f9fafb; border-radius:8px}
    .seg-summary{font-weight:600}
    .seg-count.badge{background:#f1f5f9; color:#0f172a}
  </style>
</head>
<body class="text-gray-900">
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="h-9 w-9 rounded-2xl bg-gray-900 text-white flex items-center justify-center text-sm font-semibold">C34</div>
      <div>
        <h1 class="text-lg sm:text-xl font-semibold">Tracker Campaña 3→4 — Pólizas 24 meses</h1>
        <p class="text-xs text-gray-500">Mes: <strong id="lblMes">Agosto 2025</strong> · Bono $55.000 por póliza · Campaña: <strong>3→4 (bono único)</strong> · <span class="ml-1">Brutas totales (todas): <strong id="kTotBrutas">157</strong></span> · <span>Brutas 24m: <strong id="k24Brutas">107</strong></span></p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <div class="switch flex items-center p-1" role="tablist" aria-label="Seleccionar mes">
          <button class="switch-mes active" data-mes="2025-08">Ago</button>
          <button class="switch-mes" data-mes="2025-09">Sep*</button>
        </div>
        <button id="btnPdf" class="px-3 py-1.5 rounded-xl border text-xs">Descargar PDF</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Fuente -->
    <section class="bg-white rounded-2xl p-4 shadow-sm border">
      <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
        <span>Fuente Ago: <em>Ventas al cierre Ago 25.xlsx</em> + <em>Cancelaciones GE 2025‑09‑12</em> + <em>Glosa.xlsx</em> (dealer por RUT)</span>
        <span class="mx-2">|</span>
        <span>Fuente Sep*: <em>Ventas_2025-09.xlsx</em> (acumulado a la fecha) + <em>Cancelaciones GE 2025‑09‑12</em> + <em>Glosa.xlsx</em></span>
      </div>
    </section>

    <!-- KPIs (click para filtrar tabla) -->
    <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-6">
      <div class="bg-white rounded-2xl p-4 shadow-sm border card" data-seg="0 ventas" title="Filtrar tabla: 0 ventas">
        <p class="text-xs text-gray-500">Vendedores con 0 ventas</p>
        <p id="k0" class="text-2xl font-semibold">—</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border card" data-seg="1 de 3" title="Filtrar tabla: 1/3">
        <p class="text-xs text-gray-500">A 2 de la meta (1/3)</p>
        <p id="k1" class="text-2xl font-semibold">—</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border card" data-seg="2 de 3" title="Filtrar tabla: 2/3">
        <p class="text-xs text-gray-500">A 1 de la meta (2/3)</p>
        <p id="k2" class="text-2xl font-semibold">—</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border card" data-seg="cumplió 3" title="Filtrar tabla: cumplieron 3">
        <p class="text-xs text-gray-500">Cumplieron (3 netas)</p>
        <p id="k3" class="text-2xl font-semibold">—</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border card" data-seg="sobre 3" title="Filtrar tabla: 4+">
        <p class="text-xs text-gray-500">Sobrecumplieron (4+ netas)</p>
        <p id="k4" class="text-2xl font-semibold">—</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border card" data-seg="all" title="Limpiar filtro">
        <p class="text-xs text-gray-500">Pago estimado total</p>
        <p id="kPago" class="text-2xl font-semibold">—</p>
        <p class="text-[11px] text-gray-500">Campaña: 3→4 (bono único)</p>
      </div>
    </section>

    <!-- Alertas de cancelaciones que bajan de 3 a 2 -->
    <section id="alertasBox" class="bg-white rounded-2xl p-4 shadow-sm border">
      <h3 id="alertasTitle" class="text-base font-semibold mb-2">Alertas: cayeron bajo el umbral por cancelaciones</h3>
      <div id="alertasList" class="text-sm text-gray-700"></div>
    </section>

    <!-- Listas accionables (orden por Dealer → Vendedor) -->
    <section id="segBlocks" class="grid gap-4 lg:grid-cols-3">
      <div class="bg-white rounded-2xl p-4 shadow-sm border">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h3 class="text-sm font-semibold">A 2 de la meta (1/3)</h3>
            <span class="badge bg-amber-100 text-amber-800" id="b1">—</span>
          </div>
          <div class="seg-actions flex items-center gap-1">
            <button class="seg-expand" data-target="list1" title="Expandir todo">Expandir</button>
            <button class="seg-collapse" data-target="list1" title="Colapsar todo">Colapsar</button>
          </div>
        </div>
        <div id="list1" class="seg-container"></div>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h3 class="text-sm font-semibold">A 1 de la meta (2/3)</h3>
            <span class="badge bg-emerald-100 text-emerald-800" id="b2">—</span>
          </div>
          <div class="seg-actions flex items-center gap-1">
            <button class="seg-expand" data-target="list2" title="Expandir todo">Expandir</button>
            <button class="seg-collapse" data-target="list2" title="Colapsar todo">Colapsar</button>
          </div>
        </div>
        <div id="list2" class="seg-container"></div>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h3 class="text-sm font-semibold">Cumplieron (3+)</h3>
            <span class="badge bg-indigo-100 text-indigo-800" id="b3">—</span>
          </div>
          <div class="seg-actions flex items-center gap-1">
            <button class="seg-expand" data-target="list3" title="Expandir todo">Expandir</button>
            <button class="seg-collapse" data-target="list3" title="Colapsar todo">Colapsar</button>
          </div>
        </div>
        <div id="list3" class="seg-container"></div>
      </div>
    </section>

    <!-- Tabla detalle (oculta hasta elegir KPI) -->
    <section id="tableBlock" class="bg-white rounded-2xl p-4 shadow-sm border hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <h3 class="text-base font-semibold">Detalle por vendedor (solo 24m) — <span id="lblMes2">Agosto 2025</span></h3>
          <div id="chipFilter" class="hidden items-center gap-2 text-xs border rounded-full px-2 py-1">
            <span>Filtro activo:</span>
            <span id="chipSeg" class="font-semibold"></span>
            <button id="btnClear" class="px-2 py-0.5 border rounded-full">Quitar</button>
          </div>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <label class="text-xs text-gray-500">Buscar</label>
          <input id="q" type="text" placeholder="Nombre / Rut / Dealer" class="border rounded-xl px-3 py-1.5 text-sm"/>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="tbl">
          <thead>
            <tr class="text-left text-gray-500 border-b">
              <th class="py-2 sortable" data-key="vendedor">Vendedor <span class="arrow" data-for="vendedor"></span></th>
              <th class="py-2 sortable" data-key="rut">Rut <span class="arrow" data-for="rut"></span></th>
              <th class="py-2 sortable" data-key="dealer">Dealer <span class="arrow" data-for="dealer"></span></th>
              <th class="py-2 text-right sortable" data-key="brutas">Brutas <span class="arrow" data-for="brutas"></span></th>
              <th class="py-2 text-right sortable" data-key="canc">Cancel. <span class="arrow" data-for="canc"></span></th>
              <th class="py-2 text-right sortable" data-key="netas">Netas 24m <span class="arrow" data-for="netas"></span></th>
              <th class="py-2 text-right sortable" data-key="distancia">Distancia <span class="arrow" data-for="distancia"></span></th>
              <th class="py-2 text-right sortable" data-key="objetivo">Objetivo actual <span class="arrow" data-for="objetivo"></span></th>
              <th class="py-2 text-right sortable" data-key="pago">Pago Estimado <span class="arrow" data-for="pago"></span></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100" id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    console.log('Tracker C34 — boot OK');
    const BONO = 55000;
    const nf0 = new Intl.NumberFormat('es-CL', {maximumFractionDigits:0});

    // === Datos embebidos (resumen 24m) ===
    const DATA_AUG = [
      {"vendedor": "Carla Muñoz", "rut": "20221662-5", "dealer": "Automotriz Santa Maria", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Maria Tacko", "rut": "27602851-8", "dealer": "Automotriz Santa Maria", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Jaime Maulen Gallardo", "rut": "13178401-4", "dealer": "Automotriz Santa Maria", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Robinson Bravo Romero", "rut": "13377516-0", "dealer": "Automotriz Santa Maria", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Dino Tapia Oyarzun", "rut": "10895276-8", "dealer": "Automotriz Egaña", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Robinson Andrade", "rut": "12882969-2", "dealer": "Automotriz Egaña", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Varinia Hales Fuenzalida", "rut": "13665147-8", "dealer": "Autoplus Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Paola Delgado", "rut": "13734947-7", "dealer": "Autoplus Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Roberto Salas", "rut": "12321156-6", "dealer": "CARRI", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Michelle Ferrada Soto", "rut": "18975661-7", "dealer": "Compra Justa", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Patricia Avalos", "rut": "17353061-7", "dealer": "Compra Justa", "brutas": 3, "canc": 1, "netas": 2},
      {"vendedor": "Felipe Iribarren", "rut": "18282886-4", "dealer": "DTM / Rui Zhi / JM", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Gonzalo Maldonado Merino", "rut": "14035130-7", "dealer": "DTM / Rui Zhi / JM", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Rodolfo Almeida", "rut": "13049675-1", "dealer": "DTM / Rui Zhi / JM", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Sergio Ibarra", "rut": "11740626-4", "dealer": "DTM / Rui Zhi / JM", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "José Zamora Campos", "rut": "16298077-0", "dealer": "Ek2 Spa", "brutas": 4, "canc": 0, "netas": 4},
      {"vendedor": "Garrido Comercio de Vehiculos Limitada", "rut": "96685720-7", "dealer": "Garrido Autos", "brutas": 4, "canc": 0, "netas": 4},
      {"vendedor": "Fabián Chunir Gonzales", "rut": "19593822-7", "dealer": "Guillermo Morales Ltda", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Bastián López", "rut": "19006872-1", "dealer": "Guillermo Morales Ltda", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Alvaro Piturra Rojas", "rut": "15545652-3", "dealer": "Guillermo Morales Ltda", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Franco Figueroa", "rut": "19813410-0", "dealer": "Guillermo Morales Ltda", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Monica Ramírez", "rut": "18966514-5", "dealer": "Guillermo Morales Ltda", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Sebastián Carmona Caro", "rut": "17497807-2", "dealer": "Automotriz Egaña", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Juan Chavez", "rut": "8132879-3", "dealer": "Automotriz Egaña", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Cristopher Sanchez Macaya", "rut": "19084513-0", "dealer": "Automotriz Egaña", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Cristobal Cortes", "rut": "18743877-0", "dealer": "Automotriz Egaña", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Angelo Francisco Jiron Calderon", "rut": "10867594-2", "dealer": "E. Kovacs", "brutas": 5, "canc": 0, "netas": 5},
      {"vendedor": "Juan Antonio Hermosilla", "rut": "11642492-4", "dealer": "E. Kovacs", "brutas": 5, "canc": 0, "netas": 5},
      {"vendedor": "Robert Marin", "rut": "25917664-6", "dealer": "E. Kovacs", "brutas": 5, "canc": 0, "netas": 5},
      {"vendedor": "Franklyn Teran Viera", "rut": "26211236-5", "dealer": "E. Kovacs", "brutas": 5, "canc": 0, "netas": 5},
      {"vendedor": "Raul Esteban Hernandez Soto", "rut": "18319184-5", "dealer": "E. Kovacs", "brutas": 4, "canc": 0, "netas": 4},
      {"vendedor": "Felipe Miranda", "rut": "12449791-4", "dealer": "E. Kovacs", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Maria Paz Castillo", "rut": "16539288-4", "dealer": "E. Kovacs", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Alejandra Berrios Guerrero", "rut": "18782316-1", "dealer": "E. Kovacs", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Mario Antonio Pereira Zavala", "rut": "10531636-4", "dealer": "E. Kovacs", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Yulimar De La Villa", "rut": "26330942-1", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Lucas Musura Aguirre", "rut": "17406801-1", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Cristian Jesus Vasquez Diaz", "rut": "15740429-6", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Giovanni Salvador Guerrero Molina", "rut": "18882740-0", "dealer": "Maritano Y Ebensperger", "brutas": 4, "canc": 0, "netas": 4},
      {"vendedor": "Manuel Eduardo Salcedo", "rut": "12013659-3", "dealer": "Maritano Y Ebensperger", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Cristian Espinoza Acuña", "rut": "17216194-4", "dealer": "Maritano Y Ebensperger", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Miguel Corales Castro", "rut": "15907000-K", "dealer": "Mediterraneo Automotores S.A.", "brutas": 4, "canc": 0, "netas": 4},
      {"vendedor": "Paola Gaete", "rut": "15204548-7", "dealer": "Mediterraneo Automotores S.A.", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Guillermo Jose Sesto Tognola", "rut": "12455177-5", "dealer": "Mediterraneo Automotores S.A.", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Fernanda Viviana Castañeda Fuentes", "rut": "13706316-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Gustavo Chicche Contreras", "rut": "16627957-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Pablo Luis Maldonado", "rut": "12798779-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 1, "canc": 0, "netas": 1}
    ];

    const DATA_SEP = [
      {"vendedor": "Giselle Briones Morales", "rut": "17624608-1", "dealer": "Autocredit Expres", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Enrique Chureo Niepel", "rut": "14096131-0", "dealer": "Automotriz Mirasur Temuco", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Maria Fernanda Gonzalez Acuna", "rut": "17666350-7", "dealer": "Compra Justa", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Patricia Avalos", "rut": "17353061-7", "dealer": "Compra Justa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Jorge Andres Fonseca Mella", "rut": "14293807-3", "dealer": "Ek2 Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Alexi Suazo", "rut": "13582245-8", "dealer": "Ek2 Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Fernanda Viviana Castañeda Fuentes", "rut": "13706316-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Gustavo Chicche Contreras", "rut": "16627957-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Pablo Luis Maldonado", "rut": "12798779-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Francesca Monaco", "rut": "16587640-K", "dealer": "Tecnocid", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Alexis Ayala Plaza", "rut": "13830912-6", "dealer": "Servicios Automotriz Ansar Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Alvaro Piturra Rojas", "rut": "15545652-3", "dealer": "Guillermo Morales Ltda", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Paola Delgado", "rut": "13734947-7", "dealer": "Autoplus Spa", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Cristian Espinoza Acuña", "rut": "17216194-4", "dealer": "Maritano Y Ebensperger", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Manuel Eduardo Salcedo", "rut": "12013659-3", "dealer": "Maritano Y Ebensperger", "brutas": 5, "canc": 0, "netas": 5},
      {"vendedor": "Lucas Musura Aguirre", "rut": "17406801-1", "dealer": "E. Kovacs", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Angelo Francisco Jiron Calderon", "rut": "10867594-2", "dealer": "E. Kovacs", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Ignacio Pozo", "rut": "16985635-0", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Juan Antonio Hermosilla", "rut": "11642492-4", "dealer": "E. Kovacs", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Robert Marin", "rut": "25917664-6", "dealer": "E. Kovacs", "brutas": 3, "canc": 0, "netas": 3},
      {"vendedor": "Franco Vega Lazo", "rut": "16334658-3", "dealer": "E. Kovacs", "brutas": 2, "canc": 0, "netas": 2},
      {"vendedor": "Luz Adriana Solis Barrera", "rut": "27844122-8", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Joaquin Bravo", "rut": "18823242-8", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Felipe Miranda", "rut": "12449791-4", "dealer": "E. Kovacs", "brutas": 1, "canc": 0, "netas": 1},
      {"vendedor": "Miguel Corales Castro", "rut": "15907000-K", "dealer": "Mediterraneo Automotores S.A.", "brutas": 3, "canc": 0, "netas": 3}
    ];

    // === Universo GLOSA (110 únicos) — recorte incluido ===
    const UNIVERSE = [
      {"rut":"25927371-4","vendedor":"Carlos Albornoz Rojas","dealer":"Agusavi.Cl"},
      {"rut":"17200221-8","vendedor":"Francisco Carrasco Mainguyague","dealer":"Autoclick"},
      {"rut":"17624608-1","vendedor":"Giselle Briones Morales","dealer":"Autocredit Expres"},
      {"rut":"16587640-K","vendedor":"Francesca Monaco","dealer":"Tecnocid"},
      {"rut":"17370604-7","vendedor":"Cristian Araya Sepulveda","dealer":"Mdl Autos"},
      {"rut":"16466959-9","vendedor":"Harol Hernan Quiroz Aranea","dealer":"Mdl Autos"},
      {"rut":"19655567-5","vendedor":"Katherine Quebedo Alvarado","dealer":"Mdl Autos"},
      {"rut":"20075929-3","vendedor":"Ignacio Francisco Vielma Muñoz","dealer":"Mdl Autos"},
      {"rut":"17216194-4","vendedor":"Cristian Espinoza Acuña","dealer":"Maritano Y Ebensperger"},
      {"rut":"12013659-3","vendedor":"Manuel Eduardo Salcedo","dealer":"Maritano Y Ebensperger"},
      {"rut":"18882740-0","vendedor":"Giovanni Salvador Guerrero Molina","dealer":"Maritano Y Ebensperger"},
      {"rut":"10817163-5","vendedor":"Alexis Arturo Diaz Diaz","dealer":"Maritano Y Ebensperger"},
      {"rut":"17611195-2","vendedor":"Juan Orrego","dealer":"Maritano Y Ebensperger"},
      {"rut":"18910961-3","vendedor":"Alvaro Mora","dealer":"Maritano Y Ebensperger"},
      {"rut":"13493389-6","vendedor":"Rene Igor Villanueva","dealer":"Maritano Y Ebensperger"},
      {"rut":"17223422-2","vendedor":"Cristian Rogelio Cienfuegos Cisterna","dealer":"Maritano Y Ebensperger"},
      {"rut":"13483724-9","vendedor":"Rodrigo Cortes","dealer":"Maritano Y Ebensperger"},
      {"rut":"15899791-0","vendedor":"Fernanda Santander","dealer":"Maritano Y Ebensperger"},
      {"rut":"18391884-5","vendedor":"Alfredo Marambio Oyarce","dealer":"Portal Motors"},
      {"rut":"16516653-5","vendedor":"Cristhian Rojas Muñoz","dealer":"Portal Motors"},
      {"rut":"17406801-1","vendedor":"Lucas Musura Aguirre","dealer":"E. Kovacs"},
      {"rut":"25917664-6","vendedor":"Robert Marin","dealer":"E. Kovacs"},
      {"rut":"18319184-5","vendedor":"Raul Esteban Hernandez Soto","dealer":"E. Kovacs"},
      {"rut":"10867594-2","vendedor":"Angelo Francisco Jiron Calderon","dealer":"E. Kovacs"},
      {"rut":"11642492-4","vendedor":"Juan Antonio Hermosilla","dealer":"E. Kovacs"},
      {"rut":"12449791-4","vendedor":"Felipe Miranda","dealer":"E. Kovacs"},
      {"rut":"16334658-3","vendedor":"Franco Vega Lazo","dealer":"E. Kovacs"},
      {"rut":"16985635-0","vendedor":"Ignacio Pozo","dealer":"E. Kovacs"},
      {"rut":"10531636-4","vendedor":"Mario Antonio Pereira Zavala","dealer":"E. Kovacs"},
      {"rut":"14083644-3","vendedor":"Julio Joaquin Silva Chacon","dealer":"E. Kovacs"},
      {"rut":"15740429-6","vendedor":"Cristian Jesus Vasquez Diaz","dealer":"E. Kovacs"},
      {"rut":"16539288-4","vendedor":"Maria Paz Castillo","dealer":"E. Kovacs"},
      {"rut":"18823242-8","vendedor":"Joaquin Bravo","dealer":"E. Kovacs"},
      {"rut":"27844122-8","vendedor":"Luz Adriana Solis Barrera","dealer":"E. Kovacs"},
      {"rut":"96685720-7","vendedor":"Garrido Comercio de Vehiculos Limitada","dealer":"Garrido Autos"},
      {"rut":"16048848-1","vendedor":"Sebastian Villarroel","dealer":"Garrido Autos"},
      {"rut":"17842224-1","vendedor":"Juan Pablo Cobos","dealer":"Garrido Autos"},
      {"rut":"16298077-0","vendedor":"José Zamora Campos","dealer":"Ek2 Spa"},
      {"rut":"14293807-3","vendedor":"Jorge Andres Fonseca Mella","dealer":"Ek2 Spa"},
      {"rut":"13582245-8","vendedor":"Alexi Suazo","dealer":"Ek2 Spa"},
      {"rut":"15989234-7","vendedor":"Ramiro Alejandro Moyano Tapia","dealer":"Ek2 Spa"},
      {"rut":"20221662-5","vendedor":"Carla Muñoz","dealer":"Automotriz Santa Maria"},
      {"rut":"13377516-0","vendedor":"Robinson Bravo Romero","dealer":"Automotriz Santa Maria"},
      {"rut":"13178401-4","vendedor":"Jaime Maulen Gallardo","dealer":"Automotriz Santa Maria"},
      {"rut":"27602851-8","vendedor":"Maria Tacko","dealer":"Automotriz Santa Maria"},
      {"rut":"18966514-5","vendedor":"Monica Ramírez","dealer":"Guillermo Morales Ltda"},
      {"rut":"19813410-0","vendedor":"Franco Figueroa","dealer":"Guillermo Morales Ltda"},
      {"rut":"19593822-7","vendedor":"Fabián Chunir Gonzales","dealer":"Guillermo Morales Ltda"},
      {"rut":"15545652-3","vendedor":"Alvaro Piturra Rojas","dealer":"Guillermo Morales Ltda"},
      {"rut":"19006872-1","vendedor":"Bastián López","dealer":"Guillermo Morales Ltda"},
      {"rut":"17353061-7","vendedor":"Patricia Avalos","dealer":"Compra Justa"},
      {"rut":"18975661-7","vendedor":"Michelle Ferrada Soto","dealer":"Compra Justa"},
      {"rut":"17666350-7","vendedor":"Maria Fernanda Gonzalez Acuna","dealer":"Compra Justa"},
      {"rut":"15204548-7","vendedor":"Paola Gaete","dealer":"Mediterraneo Automotores S.A."},
      {"rut":"15907000-K","vendedor":"Miguel Corales Castro","dealer":"Mediterraneo Automotores S.A."},
      {"rut":"12455177-5","vendedor":"Guillermo Jose Sesto Tognola","dealer":"Mediterraneo Automotores S.A."},
      {"rut":"13734947-7","vendedor":"Paola Delgado","dealer":"Autoplus Spa"},
      {"rut":"13665147-8","vendedor":"Varinia Hales Fuenzalida","dealer":"Autoplus Spa"},
      {"rut":"12321156-6","vendedor":"Roberto Salas","dealer":"CARRI"},
      {"rut":"14096131-0","vendedor":"Enrique Chureo Niepel","dealer":"Automotriz Mirasur Temuco"},
      {"rut":"10895276-8","vendedor":"Dino Tapia Oyarzun","dealer":"Automotriz Egaña"},
      {"rut":"19084513-0","vendedor":"Cristopher Sanchez Macaya","dealer":"Automotriz Egaña"}
      // ... resto recortado para ejemplo visual (se puede pegar completo si se requiere 110 exacto)
    ];

    // === DATASETS ===
    const DATASETS = {
      '2025-08': { label: 'Agosto 2025',            totals: { all: 157, m24: 107 }, rows: DATA_AUG },
      '2025-09': { label: 'Septiembre 2025 (acum)', totals: { all:  63, m24:  46 }, rows: DATA_SEP }
    };

    const state = { mes:'2025-08', full: [], filterSeg: null, sortKey: 'pago', sortDir: 'desc' };

    function aggregateByRut(rows){
      const map = new Map();
      rows.forEach(r=>{
        if(!map.has(r.rut)) map.set(r.rut, {...r});
        else{
          const t = map.get(r.rut);
          t.brutas += (r.brutas||0);
          t.canc   += (r.canc||0);
          t.netas  += (r.netas||0);
        }
      });
      return Array.from(map.values());
    }

    function recalc(){
      const cur = DATASETS[state.mes];
      const src = aggregateByRut(cur.rows||[]);
      const uniSet = new Set(UNIVERSE.map(u=>u.rut));
      const merged = UNIVERSE.map(u=>{
        const r = src.find(x=>x.rut===u.rut);
        const brutas = r ? r.brutas : 0;
        const canc   = r ? r.canc   : 0;
        const netas  = r ? r.netas  : 0;
        const objetivo = 3;
        const pago = (netas*BONO) + (netas>=3?BONO:0);
        const distancia = Math.max(0, objetivo - netas);
        let segmento = '0 ventas';
        if(netas===1) segmento='1 de 3';
        else if(netas===2) segmento='2 de 3';
        else if(netas===3) segmento='cumplió 3';
        else if(netas>3) segmento='sobre 3';
        return {vendedor:u.vendedor, rut:u.rut, dealer:u.dealer, brutas, canc, netas, pago, distancia, objetivo, segmento};
      });
      const extras = src.filter(r=>!uniSet.has(r.rut)).map(x=>{
        const objetivo = 3;
        const pago = (x.netas*BONO) + (x.netas>=3?BONO:0);
        const distancia = Math.max(0, objetivo - x.netas);
        let segmento = '0 ventas';
        if(x.netas===1) segmento='1 de 3';
        else if(x.netas===2) segmento='2 de 3';
        else if(x.netas===3) segmento='cumplió 3';
        else if(x.netas>3) segmento='sobre 3';
        return {...x, pago, distancia, objetivo, segmento};
      });
      state.full = merged.concat(extras);
      render();
      selfTests();
    }

    function sortByDealerVendor(a,b){
      return (a.dealer||'').localeCompare(b.dealer||'') || (a.vendedor||'').localeCompare(b.vendedor||'');
    }

    function setSortArrows(){
      document.querySelectorAll('th.sortable .arrow').forEach(el=>{ el.textContent=''; });
      const arrow = document.querySelector(`th.sortable[data-key="${state.sortKey}"] .arrow`);
      if(arrow) arrow.textContent = state.sortDir==='asc'?'▲':'▼';
    }

    function groupByDealer(list){
      const map = new Map();
      list.forEach(x=>{ const k=x.dealer||'—'; if(!map.has(k)) map.set(k,[]); map.get(k).push(x); });
      return Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([dealer, rows])=>({ dealer, rows: rows.sort((a,b)=> (a.vendedor||'').localeCompare(b.vendedor||'')) }));
    }

    function renderSegment(list, containerId, variant){
      const cont = document.getElementById(containerId);
      if(!cont) return;
      if(!list.length){ cont.innerHTML = '<p class="text-xs text-gray-500">—</p>'; return; }
      const color = variant==='amber' ? 'bg-amber-100 text-amber-800' : variant==='emerald' ? 'bg-emerald-100 text-emerald-800' : 'bg-indigo-100 text-indigo-800';
      const dot = variant==='amber' ? 'bg-amber-500' : variant==='emerald' ? 'bg-emerald-500' : 'bg-indigo-500';
      const groups = groupByDealer(list);
      cont.innerHTML = groups.map(g=>{
        const inner = g.rows.map(r=> `<li class="seg-li"><span class="seg-vendor"><span class="seg-dot ${dot}"></span><a href="#" class="underline jump" data-q="${r.vendedor.replace(/\"/g,'&quot;')}">${r.vendedor}</a></span><span class="seg-pill">${r.netas}</span></li>`).join('');
        return `<details class="seg-details"><summary class="seg-summary flex items-center justify-between"><span>${g.dealer}</span><span class="badge seg-count ${color}">${g.rows.length}</span></summary><ul class="seg-ul">${inner}</ul></details>`;
      }).join('');
    }

    function updateTableVisibility(){
      const tb = document.getElementById('tableBlock');
      const show = !!(state.filterSeg && state.filterSeg!=='all');
      if(tb){ tb.classList.toggle('hidden', !show); }
    }

    function render(){
      const cur = DATASETS[state.mes];
      const arr = state.full.slice();

      document.getElementById('lblMes').textContent = cur.label;
      document.getElementById('lblMes2').textContent = cur.label;
      document.getElementById('k24Brutas').textContent = nf0.format(cur.totals.m24);
      document.getElementById('kTotBrutas').textContent = nf0.format(cur.totals.all);

      // KPIs
      const k0 = arr.filter(x=>x.netas===0).length;
      const k1 = arr.filter(x=>x.netas===1).length;
      const k2 = arr.filter(x=>x.netas===2).length;
      const k3 = arr.filter(x=>x.netas===3).length;
      const k4 = arr.filter(x=>x.netas>3).length;
      const totalPago = arr.reduce((s,x)=>s+x.pago,0);
      document.getElementById('k0').textContent = nf0.format(k0);
      document.getElementById('k1').textContent = nf0.format(k1);
      document.getElementById('k2').textContent = nf0.format(k2);
      document.getElementById('k3').textContent = nf0.format(k3);
      document.getElementById('k4').textContent = nf0.format(k4);
      document.getElementById('kPago').textContent = '$'+nf0.format(totalPago);

      // Alertas (brutas≥3 y netas<3)
      const alertas = arr.filter(x=> x.brutas>=3 && x.netas<3);
      document.getElementById('alertasTitle').textContent = `Alertas: cayeron bajo el umbral por cancelaciones (${alertas.length})`;
      document.getElementById('alertasList').innerHTML = alertas.length
        ? alertas.sort(sortByDealerVendor).map(a=>`<div class="py-1 flex items-center justify-between"><span>${a.vendedor} <span class="text-gray-400">(${a.dealer})</span></span><span class="text-xs text-gray-500">Tenías ${a.brutas}, canceladas ${a.canc} → netas ${a.netas}</span></div>`).join('')
        : '<div class="text-sm text-gray-500">Sin alertas este mes (brutas ≥ 3 y netas < 3).</div>';

      // Listas accionables
      const l1 = arr.filter(x=>x.netas===1).sort(sortByDealerVendor);
      const l2 = arr.filter(x=>x.netas===2).sort(sortByDealerVendor);
      const l3 = arr.filter(x=>x.netas>=3).sort(sortByDealerVendor);
      document.getElementById('b1').textContent = l1.length;
      document.getElementById('b2').textContent = l2.length;
      document.getElementById('b3').textContent = l3.length;
      renderSegment(l1, 'list1', 'amber');
      renderSegment(l2, 'list2', 'emerald');
      renderSegment(l3, 'list3', 'indigo');

      // Tabla (filtrado + orden)
      const q = (document.getElementById('q').value||'').toLowerCase();
      const seg = state.filterSeg;
      let rows = arr.filter(r=> (!seg || seg==='all' || r.segmento===seg) && (!q || r.vendedor.toLowerCase().includes(q) || r.rut.toLowerCase().includes(q) || r.dealer.toLowerCase().includes(q)) );
      const key = state.sortKey; const dir = state.sortDir;
      rows.sort((a,b)=>{ const va=a[key], vb=b[key]; if(typeof va==='number' && typeof vb==='number') return dir==='asc'? va-vb : vb-va; return dir==='asc' ? String(va||'').localeCompare(String(vb||'')) : String(vb||'').localeCompare(String(va||'')); });
      document.getElementById('tbody').innerHTML = rows.map(r=>`<tr>
        <td class="py-1.5">${r.vendedor}</td>
        <td class="py-1.5">${r.rut}</td>
        <td class="py-1.5">${r.dealer}</td>
        <td class="py-1.5 text-right">${nf0.format(r.brutas)}</td>
        <td class="py-1.5 text-right">${nf0.format(r.canc)}</td>
        <td class="py-1.5 text-right">${nf0.format(r.netas)}</td>
        <td class="py-1.5 text-right">${nf0.format(r.distancia)}</td>
        <td class="py-1.5 text-right">${nf0.format(r.objetivo)}</td>
        <td class="py-1.5 text-right">$${nf0.format(r.pago)}</td>
      </tr>`).join('');

      const chip = document.getElementById('chipFilter');
      if(seg && seg!=='all'){ chip.classList.remove('hidden'); document.getElementById('chipSeg').textContent = seg; } else { chip.classList.add('hidden'); }
      updateCardActiveUI();
      updateTableVisibility();
      setSortArrows();
    }

    function updateCardActiveUI(){
      const seg = state.filterSeg;
      document.querySelectorAll('.card').forEach(card=>{
        const active = !!(seg && seg!=='all' && card.dataset.seg===seg);
        card.classList.toggle('ring-2', active);
        card.classList.toggle('ring-emerald-500', active);
        card.classList.toggle('border-emerald-500', active);
        card.classList.toggle('bg-emerald-50', active);
        card.setAttribute('aria-pressed', active ? 'true' : 'false');
        card.title = active ? 'Filtro activo' : card.title;
      });
    }

    // Eventos
    document.addEventListener('click', (e)=>{
      const card = e.target.closest('.card');
      if(card){
        const seg = card.dataset.seg || null;
        if(seg==='all'){ state.filterSeg = null; }
        else if(state.filterSeg===seg){ state.filterSeg = null; }
        else { state.filterSeg = seg; }
        render();
        return;
      }
      const btn = e.target.closest('.switch-mes');
      if(btn){
        document.querySelectorAll('.switch-mes').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        state.mes = btn.dataset.mes;
        state.filterSeg = null;
        state.sortKey='pago'; state.sortDir='desc';
        document.getElementById('q').value='';
        recalc();
        return;
      }
      if(e.target && e.target.id==='btnClear'){ state.filterSeg = null; render(); return; }
      if(e.target && e.target.classList.contains('seg-expand')){
        const t = e.target.getAttribute('data-target');
        document.querySelectorAll(`#${t} details`).forEach(d=> d.setAttribute('open',''));
        return;
      }
      if(e.target && e.target.classList.contains('seg-collapse')){
        const t = e.target.getAttribute('data-target');
        document.querySelectorAll(`#${t} details`).forEach(d=> d.removeAttribute('open'));
        return;
      }
      if(e.target && e.target.classList.contains('jump')){
        const q = e.target.getAttribute('data-q')||'';
        const tb = document.getElementById('tableBlock');
        document.getElementById('q').value = q;
        render();
        if(tb && !tb.classList.contains('hidden')){
          document.getElementById('tbl').scrollIntoView({behavior:'smooth', block:'start'});
        }
        e.preventDefault();
        return;
      }
    });

    document.getElementById('q').addEventListener('input', render);
    document.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.key; if(!key) return;
        if(state.sortKey===key){ state.sortDir = state.sortDir==='asc'?'desc':'asc'; }
        else { state.sortKey = key; state.sortDir = (['vendedor','rut','dealer'].includes(key)?'asc':'desc'); }
        render();
      });
    });

    document.getElementById('btnPdf').addEventListener('click', ()=>{
      const el = document.querySelector('main');
      const id = state.mes==='2025-08' ? '2025-08' : '2025-09-acum';
      html2pdf().from(el).set({ margin:10, filename:`Tracker-C34-${id}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'mm', format:'a4', orientation:'portrait'} }).save();
    });

    // Tests simples (log, no frenan UI)
    function selfTests(){
      const cur = DATASETS[state.mes];
      const arr = state.full;
      try{
        if(!DATASETS['2025-08']||!DATASETS['2025-09']) console.warn('DATASETS incompletos');
        if(!Array.isArray(arr)) console.warn('state.full no es array');
        const sumBrutas24 = arr.reduce((s,x)=>s+(x.brutas||0),0);
        if(sumBrutas24 !== cur.totals.m24) console.warn(`[${cur.label}] sum brutas24=${sumBrutas24} ≠ header ${cur.totals.m24}`);
        const bad = arr.filter(x=> (x.brutas||0)!==((x.netas||0)+(x.canc||0)));
        if(bad.length) console.warn('Filas con brutas≠netas+canc', bad);
      }catch(err){ console.warn('SelfTests error', err); }
    }

    // Init
    (function init(){
      state.mes='2025-08';
      state.sortKey='pago'; state.sortDir='desc';
      recalc();
    })();
  </script>
</body>
</html>
